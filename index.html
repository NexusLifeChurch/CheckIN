<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-in</title>
    <!-- Google Fonts: Prompt -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Tailwind CSS for Layout -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%);
            min-height: 100vh;
        }
        .coffee-gradient {
            background: linear-gradient(to right, #6f4e37, #a67b5b);
        }
        .coffee-card {
            background: rgba(255, 255, 255, 0.9);
            border-left: 5px solid #6f4e37;
            transition: transform 0.2s;
        }
        .coffee-card:hover {
            transform: translateY(-3px);
        }
        .tab-active {
            border-bottom: 3px solid #6f4e37;
            color: #6f4e37;
            font-weight: 700;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6f4e37;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <!-- Header -->
    <header class="coffee-gradient text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight">Activity Check-in</h1>
            <div id="userProfile" class="flex items-center gap-2">
                <div id="loaderProfile" class="w-8 h-8 rounded-full bg-white/20 animate-pulse"></div>
            </div>
        </div>
    </header>

    <!-- Top Navigation Tabs -->
    <nav class="bg-white/80 backdrop-blur-sm shadow-sm sticky top-[64px] z-40">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="py-3 px-4 text-sm font-medium tab-active">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
            <button onclick="switchTab('history')" id="tab-history" class="py-3 px-4 text-sm font-medium text-slate-400">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button onclick="switchTab('help')" id="tab-help" class="py-3 px-4 text-sm font-medium text-slate-400">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-6 mb-20">
        
        <!-- Tab 1: Dashboard -->
        <div id="content-dashboard" class="space-y-4">
            <div id="dashboard-loading" class="flex flex-col items-center py-20 text-slate-400">
                <div class="loader mb-2"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
            </div>
            <div id="dashboard-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="dashboard-error" class="hidden bg-white p-8 rounded-2xl shadow-sm text-center border-t-4 border-red-400">
                <p id="error-text" class="text-slate-600 font-medium"></p>
            </div>
        </div>

        <!-- Tab 2: History -->
        <div id="content-history" class="hidden space-y-4">
            <h2 class="font-bold text-lg text-amber-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
            <div id="history-list" class="space-y-3"></div>
        </div>

        <!-- Tab 3: Help -->
        <div id="content-help" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm">
                <h2 class="font-bold text-lg mb-4">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex gap-2"><span>1.</span> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏ô‡∏π LINE</li>
                    <li class="flex gap-2"><span>2.</span> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ZOOM ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</li>
                    <li class="flex gap-2"><span>3.</span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ ZOOM</li>
                </ul>
            </div>
            <div class="text-center">
                <p class="text-xs text-slate-400 mb-2">‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
                <a href="https://line.me/ti/p/@admin" class="inline-block coffee-gradient text-white px-8 py-3 rounded-full font-bold shadow-md hover:opacity-90 transition-all">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</a>
            </div>
        </div>
    </main>

    <script>
        // CONFIGURATION
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-p-Mc7Eu059t4n2fnTxhBl07NM98TeEq4Ng6FPMtriMtVotUx7YCrec8K6iBeadPBvw/exec"; // *** ‡∏ô‡∏≥ URL ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy GAS ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ***
        const LIFF_ID = "2008560135-XxjApLRo";

        let currentUser = null;
        let currentType = new URLSearchParams(window.location.search).get('type') || 'Community';

        async function initApp() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                currentUser = profile;
                document.getElementById('userProfile').innerHTML = `
                    <span class="text-xs font-medium hidden md:block">${profile.displayName}</span>
                    <img src="${profile.pictureUrl}" class="w-8 h-8 rounded-full border-2 border-white/50 shadow-sm">
                `;
                loadDashboard();
            } catch (err) {
                console.error("LIFF Init Error:", err);
            }
        }

        async function loadDashboard() {
            showLoader('dashboard', true);
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getDashboard&userId=${currentUser.userId}&type=${currentType}`);
                const data = await response.json();
                
                if (data.errorMessage) {
                    document.getElementById('dashboard-list').innerHTML = '';
                    document.getElementById('dashboard-error').classList.remove('hidden');
                    document.getElementById('error-text').innerText = data.errorMessage;
                } else {
                    renderActivities(data.activities, data.user);
                }
            } catch (err) {
                Swal.fire("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
            } finally {
                showLoader('dashboard', false);
            }
        }

        function renderActivities(list, userData) {
            const container = document.getElementById('dashboard-list');
            document.getElementById('dashboard-error').classList.add('hidden');
            
            if (list.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center py-20 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                return;
            }

            container.innerHTML = list.map(act => {
                const timeStatus = checkTimeRule(act.Act_Date, act.StartTime, act.EndTime);
                return `
                    <div class="coffee-card p-5 rounded-2xl shadow-sm space-y-3">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold px-2 py-0.5 bg-amber-100 text-amber-800 rounded uppercase tracking-wider">${act.Act_Type}</span>
                            <span class="text-xs font-bold ${timeStatus.color}">${timeStatus.label}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 leading-tight">${act.Act_Name}</h3>
                        <p class="text-xs text-slate-500 line-clamp-2">${act.Act_Description || ''}</p>
                        <div class="flex items-center gap-2 text-xs text-slate-400">
                             <span>üìÖ ${act.Act_Date}</span>
                             <span>‚è∞ ${act.StartTime}-${act.EndTime}</span>
                        </div>
                        ${timeStatus.canJoin ? 
                            `<button onclick="handleCheckIn('${encodeURIComponent(JSON.stringify(act))}', '${encodeURIComponent(JSON.stringify(userData))}')" 
                                class="w-full coffee-gradient text-white py-3 rounded-xl font-bold shadow-md active:scale-95 transition-all">
                                üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ZOOM
                            </button>` : 
                            `<button disabled class="w-full bg-slate-100 text-slate-400 py-3 rounded-xl font-bold cursor-not-allowed">
                                ${timeStatus.buttonText}
                            </button>`
                        }
                    </div>
                `;
            }).join('');
        }

        function checkTimeRule(dateStr, start, end) {
            // ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏° Format ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô Sheet)
            const now = new Date();
            const [d, m, y] = dateStr.split('/');
            const startTime = new Date(`${y}-${m}-${d}T${start}:00`);
            const endTime = new Date(`${y}-${m}-${d}T${end}:00`);
            const diffMin = (startTime - now) / (1000 * 60);

            if (now > endTime) return { label: "‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß", color: "text-slate-400", canJoin: false, buttonText: "‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô" };
            if (now >= startTime && now <= endTime) return { label: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß", color: "text-emerald-500", canJoin: true };
            if (diffMin <= 15) return { label: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß", color: "text-orange-500", canJoin: false, buttonText: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ" };
            
            return { label: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î", color: "text-slate-400", canJoin: false, buttonText: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤" };
        }

        async function handleCheckIn(actEncoded, userEncoded) {
            const act = JSON.parse(decodeURIComponent(actEncoded));
            const user = JSON.parse(decodeURIComponent(userEncoded));

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                text: '‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ZOOM ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const payload = {
                    action: 'checkIn',
                    data: {
                        LineUserID: currentUser.userId,
                        MemberName: user.MemberName || user.LineRegisterName || currentUser.displayName,
                        MemberID: user.MemberID || currentUser.displayName,
                        MemberCare: user.MemberCare || "Visitors",
                        Act_Type: act.Act_Type,
                        Act_Name: act.Act_Name,
                        Act_Description: act.Act_Description,
                        Act_Date: act.Act_Date,
                        Zoom_Name: act.ZOOM_name,
                        isFirstTime: "False"
                    }
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.status === 'success' || result.status === 'already_checked_in') {
                    Swal.close();
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß -> ‡πÄ‡∏õ‡∏¥‡∏î ZOOM
                    liff.openWindow({
                        url: act.ZOOM_Link,
                        external: true
                    });
                }
            } catch (err) {
                Swal.fire("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ", "warning").then(() => {
                    liff.openWindow({ url: act.ZOOM_Link, external: true });
                });
            }
        }

        function switchTab(tab) {
            ['dashboard', 'history', 'help'].forEach(t => {
                document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
                document.getElementById(`tab-${t}`).className = `py-3 px-4 text-sm font-medium ${t === tab ? 'tab-active' : 'text-slate-400'}`;
            });
            if (tab === 'history') loadHistory();
        }

        async function loadHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '<div class="loader mx-auto"></div>';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getHistory&userId=${currentUser.userId}`);
                const data = await response.json();
                container.innerHTML = data.history.map(h => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-amber-200">
                        <div class="text-[10px] text-slate-400">${new Date(h.Timestamp).toLocaleString()}</div>
                        <div class="font-bold text-slate-700">${h.Act_Name}</div>
                        <div class="text-xs text-slate-500">${h.Act_Type} ‚Ä¢ Online</div>
                    </div>
                `).join('') || '<p class="text-center text-slate-400 py-10">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</p>';
            } catch (err) {
                container.innerHTML = '<p class="text-red-400">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
            }
        }

        function showLoader(part, show) {
            const el = document.getElementById(`${part}-loading`);
            if (el) el.classList.toggle('hidden', !show);
        }

        window.onload = initApp;
    </script>
</body>
</html>
