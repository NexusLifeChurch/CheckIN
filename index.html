<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-in</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); min-height: 100vh; }
        .coffee-gradient { background: linear-gradient(to right, #6f4e37, #a67b5b); }
        .coffee-card { background: rgba(255, 255, 255, 0.95); border-left: 6px solid #6f4e37; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 4px solid #6f4e37; color: #6f4e37; font-weight: 700; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6f4e37; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <header class="coffee-gradient text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">Activity Check-in</h1>
                <p class="text-[10px] opacity-80" id="currentDateHeader"></p>
            </div>
            <div id="userProfile" class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 animate-pulse"></div>
            </div>
        </div>
    </header>

    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-[76px] z-40">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="py-4 px-6 text-sm font-medium tab-active">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            <button onclick="switchTab('history')" id="tab-history" class="py-4 px-6 text-sm font-medium text-slate-400">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button onclick="switchTab('help')" id="tab-help" class="py-4 px-6 text-sm font-medium text-slate-400">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-8 mb-10">
        <div id="content-dashboard" class="space-y-6">
            <div id="dashboard-loading" class="flex flex-col items-center py-24 text-slate-400">
                <div class="loader mb-4"></div>
                <p class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
            </div>
            <div id="dashboard-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            <div id="dashboard-error" class="hidden bg-white p-10 rounded-3xl shadow-xl text-center border-t-8 border-red-500">
                <p id="error-text" class="text-slate-700 font-bold text-lg"></p>
                <button onclick="location.reload()" class="mt-4 coffee-gradient text-white px-8 py-2 rounded-full font-bold">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
        </div>
        <div id="content-history" class="hidden space-y-4"></div>
        <div id="content-help" class="hidden space-y-6"></div>
    </main>

    <footer class="pb-10 pt-4 text-center">
        <p class="text-[9px] text-slate-400 uppercase tracking-widest opacity-50" id="versionTag">v1.0.7 - 2025.12.30</p>
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-p-Mc7Eu059t4n2fnTxhBl07NM98TeEq4Ng6FPMtriMtVotUx7YCrec8K6iBeadPBvw/exec"; 
        const LIFF_ID = "2008560135-XxjApLRo";
        const APP_VERSION = "v1.0.7 (Stable Date/Time)";

        let currentUser = null;
        let countdownIntervals = [];
        const urlParams = new URLSearchParams(window.location.search);
        let currentType = urlParams.get('Type') || urlParams.get('type') || 'Community';

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ISO (yyyy-mm-dd) ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
        function toThaiDate(isoDate) {
            if (!isoDate || typeof isoDate !== 'string') return "-";
            const [y, m, d] = isoDate.split('-').map(Number);
            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            const dateObj = new Date(y, m - 1, d);
            
            const now = new Date(); now.setHours(0,0,0,0);
            const target = new Date(y, m - 1, d); target.setHours(0,0,0,0);
            const diff = Math.round((target - now) / (1000 * 60 * 60 * 24));
            
            let remain = diff === 0 ? " (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)" : (diff === 1 ? " (‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ)" : (diff > 1 ? ` (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${diff} ‡∏ß‡∏±‡∏ô)` : ""));
            return `‡∏ß‡∏±‡∏ô${days[dateObj.getDay()]}‡∏ó‡∏µ‡πà ${d} ${months[m-1]} ${y+543}${remain}`;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤ 15 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ String Math)
        function getCheckInOpen(startTime) {
            let [h, m] = startTime.split(':').map(Number);
            let total = h * 60 + m - 15;
            let rh = Math.floor(total / 60);
            let rm = total % 60;
            return `${rh.toString().padStart(2, '0')}:${rm.toString().padStart(2, '0')}`;
        }

        async function initApp() {
            try {
                document.getElementById('versionTag').innerText = `Version ${APP_VERSION}`;
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUser = profile;
                document.getElementById('userProfile').innerHTML = `<img src="${profile.pictureUrl}" class="w-10 h-10 rounded-full border-2 border-white/50">`;
                loadDashboard();
            } catch (err) { console.error(err); }
        }

        async function loadDashboard() {
            showLoader('dashboard', true);
            document.getElementById('dashboard-error').classList.add('hidden');
            countdownIntervals.forEach(clearInterval);
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getDashboard&userId=${currentUser.userId}&type=${currentType}`);
                const data = await response.json();
                
                if (data.errorMessage) {
                    document.getElementById('dashboard-list').innerHTML = '';
                    document.getElementById('dashboard-error').classList.remove('hidden');
                    document.getElementById('error-text').innerText = data.errorMessage;
                } else {
                    renderActivities(data.activities, data.user);
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
                    document.getElementById('currentDateHeader').innerText = "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
                }
            } catch (err) {
                document.getElementById('dashboard-error').classList.remove('hidden');
                document.getElementById('error-text').innerText = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
            } finally { showLoader('dashboard', false); }
        }

        function renderActivities(list, userData) {
            const container = document.getElementById('dashboard-list');
            container.innerHTML = list.map((act, index) => {
                const checkInOpenTime = getCheckInOpen(act.StartTime);
                return `
                    <div class="coffee-card p-6 rounded-3xl space-y-4">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold px-3 py-1 bg-amber-100 text-amber-800 rounded-full uppercase tracking-widest">${act.Act_Type}</span>
                            <div id="timer-${index}" class="text-[10px] font-bold"></div>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg leading-tight">${act.Act_Name}</h3>
                        <div class="space-y-1">
                            <p class="text-xs text-slate-500">üìÖ ${toThaiDate(act.Act_Date)}</p>
                            <p class="text-xs text-amber-700 font-semibold">‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î ZOOM ${checkInOpenTime} ‡∏ô.</p>
                        </div>
                        <div id="btn-${index}"></div>
                    </div>
                `;
            }).join('');

            list.forEach((act, index) => {
                const tick = () => {
                    const now = new Date();
                    const [y, mo, d] = act.Act_Date.split('-').map(Number);
                    const [sh, sm] = act.StartTime.split(':').map(Number);
                    const [eh, em] = act.EndTime.split(':').map(Number);
                    
                    const start = new Date(y, mo - 1, d, sh, sm, 0);
                    const end = new Date(y, mo - 1, d, eh, em, 0);
                    const checkInOpen = new Date(start.getTime() - 15 * 60000);

                    const statusEl = document.getElementById(`timer-${index}`);
                    const btnEl = document.getElementById(`btn-${index}`);

                    if (now > end) {
                        statusEl.innerText = "‡∏à‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß";
                        btnEl.innerHTML = `<button disabled class="w-full bg-slate-100 text-slate-400 py-3 rounded-2xl font-bold">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>`;
                    } else if (now >= start && now <= end) {
                        statusEl.innerText = "‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà";
                        statusEl.className = "text-[10px] font-bold text-emerald-500 animate-pulse";
                        btnEl.innerHTML = `<button onclick="handleCheckIn('${encodeURIComponent(JSON.stringify(act))}', '${encodeURIComponent(JSON.stringify(userData))}')" class="w-full coffee-gradient text-white py-4 rounded-2xl font-bold shadow-lg">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ZOOM</button>`;
                    } else if (now >= checkInOpen && now < start) {
                        const diff = Math.floor((start - now) / 1000);
                        const mm = Math.floor(diff / 60);
                        const ss = diff % 60;
                        statusEl.innerText = `‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${mm}:${ss.toString().padStart(2, '0')}`;
                        statusEl.className = "text-[10px] font-bold text-orange-500";
                        btnEl.innerHTML = `<button disabled class="w-full bg-amber-50 text-amber-300 py-3 rounded-2xl font-bold">‡∏£‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î...</button>`;
                    } else {
                        statusEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
                        btnEl.innerHTML = `<div class="bg-slate-50 p-3 rounded-2xl text-center text-[9px] text-slate-400">‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô ${checkInOpenTime} ‡∏ô.</div>`;
                    }
                };
                tick();
                countdownIntervals.push(setInterval(tick, 1000));
            });
        }

        async function handleCheckIn(actEncoded, userEncoded) {
            const act = JSON.parse(decodeURIComponent(actEncoded));
            const user = JSON.parse(decodeURIComponent(userEncoded));
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', html: '<div class="loader mx-auto mb-4"></div>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', showConfirmButton: false });
            try {
                const payload = { action: 'checkIn', data: { LineUserID: currentUser.userId, MemberName: user.MemberName || user.LineRegisterName || currentUser.displayName, MemberID: user.MemberID || currentUser.displayName, MemberCare: user.MemberCare || "Visitors", Act_Type: act.Act_Type, Act_Name: act.Act_Name, Act_Date: act.Act_Date, Zoom_Name: act.Zoom_Name } };
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                setTimeout(() => { Swal.close(); liff.openWindow({ url: act.ZOOM_Link, external: true }); }, 1000);
            } catch (err) { liff.openWindow({ url: act.ZOOM_Link, external: true }); }
        }

        function switchTab(t) {
            ['dashboard', 'history', 'help'].forEach(tab => {
                document.getElementById(`content-${tab}`).classList.toggle('hidden', tab !== t);
                document.getElementById(`tab-${tab}`).className = `py-4 px-6 text-sm font-medium ${tab === t ? 'tab-active' : 'text-slate-400'}`;
            });
        }

        function showLoader(p, s) { document.getElementById(`${p}-loading`).classList.toggle('hidden', !s); }

        window.onload = initApp;
    </script>
</body>
</html>
