<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Check-in</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Prompt', sans-serif; background: linear-gradient(135deg, #fdfcfb 0%, #e2d1c3 100%); min-height: 100vh; }
        .coffee-gradient { background: linear-gradient(to right, #6f4e37, #a67b5b); }
        .coffee-card { background: rgba(255, 255, 255, 0.95); border-left: 6px solid #6f4e37; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .tab-active { border-bottom: 4px solid #6f4e37; color: #6f4e37; font-weight: 700; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #6f4e37; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800">

    <header class="coffee-gradient text-white p-5 shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight">Activity Check-in</h1>
                <p class="text-[10px] opacity-80" id="currentDateHeader"></p>
            </div>
            <div id="userProfile" class="flex items-center gap-3">
                <div id="loaderProfile" class="w-8 h-8 rounded-full bg-white/20 animate-pulse"></div>
            </div>
        </div>
    </header>

    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-[76px] z-40">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="py-4 px-6 text-sm font-medium tab-active transition-all">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
            <button onclick="switchTab('history')" id="tab-history" class="py-4 px-6 text-sm font-medium text-slate-400 transition-all">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            <button onclick="switchTab('help')" id="tab-help" class="py-4 px-6 text-sm font-medium text-slate-400 transition-all">‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-4 md:p-8 mb-10">
        <div id="content-dashboard" class="space-y-6">
            <div id="dashboard-loading" class="flex flex-col items-center py-24 text-slate-400">
                <div class="loader mb-4"></div>
                <p class="animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°...</p>
            </div>
            <div id="dashboard-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            <div id="dashboard-error" class="hidden bg-white p-10 rounded-3xl shadow-xl text-center border-t-8 border-red-500">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <p id="error-text" class="text-slate-700 font-bold text-lg mb-4"></p>
                <button onclick="location.reload()" class="coffee-gradient text-white px-8 py-2 rounded-full font-bold">‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
        </div>

        <div id="content-history" class="hidden space-y-4">
            <h2 class="font-bold text-xl text-amber-900 border-b pb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</h2>
            <div id="history-list" class="space-y-4"></div>
        </div>

        <div id="content-help" class="hidden space-y-6">
            <div class="bg-white p-8 rounded-3xl shadow-sm">
                <h2 class="font-bold text-xl mb-6 text-amber-900">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <div class="space-y-4 text-sm text-slate-600">
                    <p>1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Care ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì / Course ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</p>
                    <p>2. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏Å‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    <p>3. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ ZOOM ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="pb-10 pt-4 text-center">
        <p class="text-[9px] text-slate-400 uppercase tracking-widest opacity-50" id="versionTag">v1.0.5 - 2025.12.30</p>
    </footer>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby-p-Mc7Eu059t4n2fnTxhBl07NM98TeEq4Ng6FPMtriMtVotUx7YCrec8K6iBeadPBvw/exec"; 
        const LIFF_ID = "2008560135-XxjApLRo";
        const APP_VERSION = "v1.0.5 (Update: 30 Dec 2025)";

        let currentUser = null;
        let countdownIntervals = [];
        const urlParams = new URLSearchParams(window.location.search);
        let currentType = urlParams.get('Type') || urlParams.get('type') || 'Community';

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà MM/DD/YYYY ‡∏à‡∏≤‡∏Å Google Sheets
        function parseAnyDate(dateVal) {
            if (!dateVal) return new Date();
            
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô ISO String
            if (typeof dateVal === 'string' && dateVal.includes('T')) {
                return new Date(dateVal);
            }

            // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const parts = String(dateVal).split(/[/ -]/);
            if (parts.length === 3) {
                let p0 = parseInt(parts[0]);
                let p1 = parseInt(parts[1]);
                let p2 = parseInt(parts[2]);

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö MM/DD/YYYY (‡∏ñ‡πâ‡∏≤ p0 <= 12 ‡πÅ‡∏•‡∏∞ p1 > 12)
                if (p0 <= 12 && p1 > 12) {
                    return new Date(p2, p0 - 1, p1);
                } 
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö DD/MM/YYYY
                else if (p0 > 12 && p1 <= 12) {
                    return new Date(p2, p1 - 1, p0);
                }
            }
            return new Date(dateVal);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà HH:mm
        function formatTimeDisplay(timeVal) {
            if (!timeVal) return "00:00";
            let d = new Date(timeVal);
            if (!isNaN(d.getTime())) {
                const h = d.getHours().toString().padStart(2, '0');
                const m = d.getMinutes().toString().padStart(2, '0');
                return `${h}:${m}`;
            }
            return String(timeVal).substring(0, 5);
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ 15 ‡∏ô‡∏≤‡∏ó‡∏µ
        function getCheckInOpenTime(startTimeStr) {
            const [h, m] = startTimeStr.split(':').map(Number);
            let date = new Date();
            date.setHours(h, m, 0);
            date.setMinutes(date.getMinutes() - 15);
            return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function formatThaiDateFull(dateStr) {
            const days = ['‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå'];
            const months = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô', '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            
            let date = parseAnyDate(dateStr);
            const now = new Date();
            now.setHours(0,0,0,0);
            const target = new Date(date);
            target.setHours(0,0,0,0);
            
            const diffTime = target.getTime() - now.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            let remain = "";
            if (diffDays === 0) remain = " (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)";
            else if (diffDays === 1) remain = " (‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ)";
            else if (diffDays > 1) remain = ` (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${diffDays} ‡∏ß‡∏±‡∏ô)`;

            return `‡∏ß‡∏±‡∏ô${days[date.getDay()]}‡∏ó‡∏µ‡πà ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}${remain}`;
        }

        async function initApp() {
            try {
                document.getElementById('versionTag').innerText = `Version ${APP_VERSION}`;
                document.getElementById('currentDateHeader').innerText = formatThaiDateFull(new Date());
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                currentUser = profile;
                document.getElementById('userProfile').innerHTML = `
                    <div class="text-right hidden sm:block">
                        <p class="text-xs font-bold leading-none">${profile.displayName}</p>
                        <p class="text-[8px] opacity-70">Active</p>
                    </div>
                    <img src="${profile.pictureUrl}" class="w-10 h-10 rounded-full border-2 border-white/50 shadow-sm">
                `;
                loadDashboard();
            } catch (err) { Swal.fire("Error", "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "error"); }
        }

        async function loadDashboard() {
            showLoader('dashboard', true);
            document.getElementById('dashboard-error').classList.add('hidden');
            countdownIntervals.forEach(clearInterval);
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getDashboard&userId=${currentUser.userId}&type=${currentType}`);
                const data = await response.json();
                if (data.errorMessage) {
                    document.getElementById('dashboard-list').innerHTML = '';
                    document.getElementById('dashboard-error').classList.remove('hidden');
                    document.getElementById('error-text').innerText = data.errorMessage;
                } else {
                    renderActivities(data.activities, data.user);
                }
            } catch (err) {
                document.getElementById('dashboard-error').classList.remove('hidden');
                document.getElementById('error-text').innerText = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ";
            } finally { showLoader('dashboard', false); }
        }

        function renderActivities(list, userData) {
            const container = document.getElementById('dashboard-list');
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-20 bg-white rounded-3xl text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                return;
            }

            container.innerHTML = list.map((act, index) => {
                const startTimeStr = formatTimeDisplay(act.StartTime);
                const openTimeStr = getCheckInOpenTime(startTimeStr);
                return `
                    <div class="coffee-card p-6 rounded-3xl space-y-4" id="act-card-${index}">
                        <div class="flex justify-between items-start">
                            <span class="text-[10px] font-bold px-3 py-1 bg-amber-100 text-amber-800 rounded-full uppercase tracking-widest">${act.Act_Type}</span>
                            <div id="timer-status-${index}" class="text-[10px] font-bold"></div>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg leading-tight">${act.Act_Name}</h3>
                        <div class="space-y-1">
                            <p class="text-xs text-slate-500 flex items-center gap-2">üìÖ ${formatThaiDateFull(act.Act_Date)}</p>
                            <p class="text-xs text-amber-700 font-semibold flex items-center gap-2">‚è∞ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î ZOOM ${openTimeStr} ‡∏ô.</p>
                        </div>
                        <div id="action-area-${index}"></div>
                    </div>
                `;
            }).join('');

            list.forEach((act, index) => updateTimeStatus(act, index, userData));
        }

        function updateTimeStatus(act, index, userData) {
            const statusEl = document.getElementById(`timer-status-${index}`);
            const actionEl = document.getElementById(`action-area-${index}`);

            const tick = () => {
                const now = new Date();
                const actDate = parseAnyDate(act.Act_Date);
                const startTimeStr = formatTimeDisplay(act.StartTime);
                const endTimeStr = formatTimeDisplay(act.EndTime);
                
                const start = new Date(actDate);
                const [sH, sM] = startTimeStr.split(':').map(Number);
                start.setHours(sH, sM, 0);

                const end = new Date(actDate);
                const [eH, eM] = endTimeStr.split(':').map(Number);
                end.setHours(eH, eM, 0);
                
                const diffMs = start.getTime() - now.getTime();
                const diffMin = diffMs / (1000 * 60);

                if (now > end) {
                    statusEl.innerText = "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß";
                    statusEl.className = "text-[10px] font-bold text-slate-400";
                    actionEl.innerHTML = `<button disabled class="w-full bg-slate-100 text-slate-400 py-3 rounded-2xl font-bold cursor-not-allowed">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>`;
                } else if (now >= start && now <= end) {
                    statusEl.innerText = "‚óè ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡πâ‡∏ß";
                    statusEl.className = "text-[10px] font-bold text-emerald-500 animate-pulse";
                    actionEl.innerHTML = `<button onclick="handleCheckIn('${encodeURIComponent(JSON.stringify(act))}', '${encodeURIComponent(JSON.stringify(userData))}')" class="w-full coffee-gradient text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-all">üöÄ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° ZOOM</button>`;
                } else if (diffMin <= 15 && diffMin > 0) {
                    const min = Math.floor(diffMin);
                    const sec = Math.floor((diffMs / 1000) % 60);
                    statusEl.innerText = `‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å ${min}:${sec.toString().padStart(2, '0')}`;
                    statusEl.className = "text-[10px] font-bold text-orange-500";
                    actionEl.innerHTML = `<button disabled class="w-full bg-amber-50 text-amber-300 py-3 rounded-2xl font-bold border border-amber-100 cursor-not-allowed">‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô...</button>`;
                } else {
                    statusEl.innerText = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤";
                    statusEl.className = "text-[10px] font-bold text-slate-400";
                    actionEl.innerHTML = `<div class="bg-slate-50 p-3 rounded-2xl text-center"><p class="text-[9px] text-slate-400">‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ ${getCheckInOpenTime(startTimeStr)} ‡∏ô.</p></div>`;
                }
            };

            tick();
            countdownIntervals.push(setInterval(tick, 1000));
        }

        async function handleCheckIn(actEncoded, userEncoded) {
            const act = JSON.parse(decodeURIComponent(actEncoded));
            const user = JSON.parse(decodeURIComponent(userEncoded));
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', html: '<div class="loader mx-auto mb-4"></div>‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà ZOOM', showConfirmButton: false, allowOutsideClick: false });
            try {
                const payload = { action: 'checkIn', data: { LineUserID: currentUser.userId, MemberName: user.MemberName || user.LineRegisterName || currentUser.displayName, MemberID: user.MemberID || currentUser.displayName, MemberCare: user.MemberCare || "Visitors", Act_Type: act.Act_Type, Act_Name: act.Act_Name, Act_Description: act.Act_Description, Act_Date: act.Act_Date, Zoom_Name: act.ZOOM_name } };
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                setTimeout(() => { Swal.close(); liff.openWindow({ url: act.ZOOM_Link, external: true }); }, 1000);
            } catch (err) { liff.openWindow({ url: act.ZOOM_Link, external: true }); }
        }

        function switchTab(tab) {
            ['dashboard', 'history', 'help'].forEach(t => {
                document.getElementById(`content-${t}`).classList.toggle('hidden', t !== tab);
                document.getElementById(`tab-${t}`).className = `py-4 px-6 text-sm font-medium ${t === tab ? 'tab-active' : 'text-slate-400'}`;
            });
            if (tab === 'history') loadHistory();
        }

        async function loadHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '<div class="flex justify-center py-20"><div class="loader"></div></div>';
            try {
                const response = await fetch(`${SCRIPT_URL}?action=getHistory&userId=${currentUser.userId}`);
                const data = await response.json();
                container.innerHTML = (data.history && data.history.length > 0) ? data.history.map(h => `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border-l-4 border-amber-400">
                        <div class="flex justify-between mb-1 text-[9px] text-slate-400">
                            <p class="font-bold uppercase">${h.Act_Type}</p>
                            <p>${new Date(h.Timestamp).toLocaleString('th-TH')}</p>
                        </div>
                        <p class="font-bold text-slate-800">${h.Act_Name}</p>
                        <p class="text-[10px] text-emerald-600 font-medium">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏° Online ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>
                    </div>
                `).join('') : '<div class="text-center py-20 text-slate-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô</div>';
            } catch (err) { container.innerHTML = '<p class="text-center text-red-400 py-10">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ</p>'; }
        }

        function showLoader(part, show) {
            const el = document.getElementById(`${part}-loading`);
            if (el) el.classList.toggle('hidden', !show);
        }

        window.onload = initApp;
    </script>
</body>
</html>
